<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="text/html" charset="UTF-8">
        <title>扫雷</title>
        <style>
            #grid{
                margin: auto;
            }
            .blocks{
                width: 30px;
                height: 30px;
                line-height: 30px;
                text-align: center;
                display: block;
                background: whitesmoke;
            }
            .blocks:hover{
                background: cornflowerblue;
            }
        </style>
    </head>
    <body oncontextmenu=self.event.returnValue=false>
        <center>
            <table border="2" id="grid"></table>
        </center>
        <script>
            var gameover = false
            var initialize = 0;
            var row = 10
            var column = 10
            var mine = 20
            // 表格的数据
            var data = new Array()
            //是否显示这一格,0为默认不显示，1是标记
            var data_show = new Array();
            //存储表格
            var grid = init_show()

            //初始化表格数据
            function init(click_x,click_y) {
                //初始化表格中的雷，并确保第一个不是雷
                for (let i = 0; i < row; i++) {
                    data[i] = new Array()
                    data_show[i] = new Array()
                    for (let j = 0; j < column; j++) {
                        data[i][j] = 0
                        data_show[i][j] = 0
                    }
                }
                for (let i = 0; i < mine; i++) {
                    x = Math.floor(Math.random() * row)
                    y = Math.floor(Math.random() * column)
                    if (data[x][y] != 9 && (x!= click_x || y != click_y)) {
                        data[x][y] = 9
                    } else {
                        i--
                    }
                }
                //计算每个单元格附近的雷的数目
                for (let i = 0; i < row; i++) {
                    for (let j = 0; j < column; j++) {
                        if (data[i][j] == 9){
                           count_mine(i,j) 
                        }
                    }
                }
            }

            //增加雷坐标处附近的计数
            function count_mine(x,y) {
                try{
                    if (data[x-1][y] != 9){
                        data[x-1][y]++
                    }
                } catch (error){}
                try {
                    if (data[x+1][y] != 9){
                        data[x+1][y]++
                    }
                } catch (error) {}
                try{
                    if (data[x][y+1] != 9){
                        data[x][y+1]++
                    }
                } catch (error){}
                try {
                    if (data[x][y-1] != 9){
                        data[x][y-1]++
                    }
                } catch (error) {}
                try{
                    if (data[x+1][y-1] != 9){
                        data[x+1][y-1]++
                    }
                } catch (error){}
                try {
                    if (data[x+1][y+1] != 9){
                        data[x+1][y+1]++
                    }
                } catch (error) {}
                try{
                    if (data[x-1][y-1] != 9){
                        data[x-1][y-1]++
                    }
                } catch (error){}
                try {
                    if (data[x-1][y+1] != 9){
                        data[x-1][y+1]++
                    }
                } catch (error) {}
            }

            //初始化显示
            function init_show() {
                //生成矩阵html  <tr>--行标签 <td>--列标签
                let gridHtml = '';
                for (let i = 0; i < row; i++) {
　　                gridHtml += '<tr>'
　                  for (let j = 0; j < column; j++) {
　　　                  gridHtml += '<td><span class="blocks" onmousedown="block_click(' + i + ',' + j + ',event)"></span></td>';
　                  }
　          　      gridHtml += '<tr>'
                }
                //写入html
                document.getElementById('grid').innerHTML = gridHtml;
                let grid = new Array()
                let blocks = document.getElementsByClassName('blocks')
                for (let i = 0; i < blocks.length; i += column) {
                    grid[i / column] = new Array()
                    for (let j = 0; j < column; j++) {
                        grid[i / column][j] = blocks[i + j]
                    }
                }
                return grid
            }

            function block_click(x,y,e) {
                if (e.button === 0){
                    //左键单击
                    if(initialize === 0){
                        initialize = 1
                        init(x, y)
                        data_show[x][y] = 1
                    } else {
                        if (data[x][y] === 9){
                            gameover = true
                        }
                        data_show[x][y] = 1
                    }
                } else if (e.button === 2){
                    //右键单击
                    if(data_show[x][y] != 1){
                        if (data_show[x][y] === 0){
                            data_show[x][y] = 2
                        } else if(data_show[x][y] === 2){
                            data_show[x][y] = 0
                        }
                    } 
                }
                reshow()
            }

            function reshow() {
                if (gameover){
                    alert('游戏结束,刷新再来一局吧')
                    return
                }
                for (let i = 0; i < row; i++) {
                    for (let j = 0; j < column; j++) {
                        if(data_show[i][j] === 1){
                            grid[i][j].innerHTML = data[i][j]
                        } else if(data_show[i][j] === 2){
                            grid[i][j].innerHTML = '⚠'
                        } else {
                            grid[i][j].innerHTML = ''
                        }
                    }
                }
                //计数未翻开的格子，如果恰好是雷的数目，游戏成功
                let count = 0
                for (let i = 0; i < row; i++) {
                    for (let j = 0; j < array.column; j++) {
                        if(data_show[i][j] === 0){
                            count++
                        }
                    }
                }
                if (count === mine_count) {
                    alert('你成功了')
                }
            }

            //点开x,y单元格
            function open(x,y){

            }
        </script>
    </body>
</html>